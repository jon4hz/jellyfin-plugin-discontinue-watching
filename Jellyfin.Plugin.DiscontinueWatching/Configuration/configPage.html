<!DOCTYPE html>
<html>
  <head>
    <title>Discontinue Watching</title>
  </head>
  <body>
    <div id="DiscontinueWatchingConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
      <div data-role="content">
        <div class="content-primary">
          <form id="DiscontinueWatchingConfigForm">
            <div class="verticalSection verticalSection-extrabottompadding">
              <div class="sectionTitleContainer flex align-items-center">
                <h2 class="sectionTitle">Discontinue Watching Plugin</h2>
                <a
                  is="emby-linkbutton"
                  class="raised raised-mini emby-button"
                  style="margin-left: 2em"
                  target="_blank"
                  href="https://github.com/jon4hz/jellyfin-plugin-discontinue-watching"
                >
                  <i class="md-icon button-icon button-icon-left secondaryText"></i>
                  <span>GitHub</span>
                </a>
              </div>
              <p class="fieldDescription">
                This plugin allows users to hide items from their "Continue Watching" list. Hidden items will
                automatically reappear when playback is resumed.
              </p>
              <hr />
              <br />

              <div class="verticalSection">
                <h3 class="sectionTitle">Settings</h3>
                <div class="inputContainer">
                  <input
                    is="emby-input"
                    type="number"
                    id="daysThreshold"
                    label="Days Threshold:"
                    min="1"
                    max="365"
                    step="1"
                  />
                  <div class="fieldDescription">
                    Items that haven't been watched for this many days will be automatically removed from Continue
                    Watching by the scheduled task. (Default: 180 days)
                  </div>
                </div>
              </div>

              <br />
              <div>
                <button is="emby-button" type="submit" class="raised button-submit block">
                  <span>Save</span>
                </button>
              </div>

              <br />
              <hr />
              <br />

              <div class="verticalSection">
                <h3 class="sectionTitle">User Denylists</h3>
                <p class="fieldDescription" style="margin-bottom: 1em">
                  Manage user-specific denylists. These items are hidden from the Continue Watching section until
                  playback resumes.
                </p>
                <div id="userDenylistsContainer">
                  <p>Loading user denylists...</p>
                </div>
              </div>

              <br />
              <hr />
              <br />

              <div class="verticalSection">
                <h3 class="sectionTitle">Features</h3>
                <ul>
                  <li>Hide items from Continue Watching via API</li>
                  <li>User-specific denylist management</li>
                  <li>Automatic removal from denylist when playback resumes</li>
                  <li>Scheduled cleanup of old Continue Watching items</li>
                </ul>
              </div>

              <div class="verticalSection">
                <h3 class="sectionTitle">Scheduled Task</h3>
                <p class="fieldDescription">
                  A scheduled task runs to automatically hide items from Continue Watching that haven't been watched
                  within the configured threshold. You can manually trigger this task from the Jellyfin dashboard under
                  Scheduled Tasks.
                </p>
              </div>

              <div class="verticalSection">
                <h3 class="sectionTitle">API Endpoints</h3>
                <p class="fieldDescription">The following authenticated API endpoints are available:</p>
                <ul>
                  <li><strong>GET</strong> /DiscontinueWatching - Get all denylisted items</li>
                  <li><strong>POST</strong> /DiscontinueWatching/{itemId} - Add item to denylist</li>
                  <li><strong>DELETE</strong> /DiscontinueWatching/{itemId} - Remove item from denylist</li>
                </ul>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <template id="user-denylist-template">
      <details
        class="verticalSection"
        style="background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 1em"
      >
        <summary style="cursor: pointer; list-style: none; display: flex; align-items: center; padding: 0.75em 1em">
          <i class="material-icons arrow-icon" style="transition: transform 0.2s ease-in-out">arrow_right</i>
          <h3 class="sectionTitle user-name-header" style="margin: 0 0 0 0.5em"></h3>
        </summary>
        <div class="user-denylist-container" style="padding: 1.5em; border-top: 1px solid rgba(255, 255, 255, 0.1)">
          <div class="user-items-list"></div>
        </div>
      </details>
    </template>

    <script type="text/javascript">
      console.log('[DiscontinueWatching] DEBUG: Script tag is executing!');
      console.log('[DiscontinueWatching] DEBUG: Current page ID:', document.querySelector('[data-role="page"]')?.id);
      console.log('[DiscontinueWatching] DEBUG: Document ready state:', document.readyState);

      var DiscontinueWatchingConfig = {
        pluginId: '74a22212-e4c5-4b5c-8d77-04e7e220f28d',
        users: {},

        loadConfiguration: function () {
          console.log('[DiscontinueWatching] DEBUG: loadConfiguration() called');
          console.log('[DiscontinueWatching] DEBUG: Plugin ID:', DiscontinueWatchingConfig.pluginId);
          console.log('[DiscontinueWatching] DEBUG: ApiClient available:', typeof ApiClient !== 'undefined');
          console.log('[DiscontinueWatching] DEBUG: Dashboard available:', typeof Dashboard !== 'undefined');

          Dashboard.showLoadingMsg();
          ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId)
            .then(function (config) {
              console.log('[DiscontinueWatching] DEBUG: Configuration loaded successfully:', config);
              console.log('[DiscontinueWatching] DEBUG: DaysThreshold value:', config.DaysThreshold);

              var thresholdElement = document.getElementById('daysThreshold');
              console.log('[DiscontinueWatching] DEBUG: Threshold input element found:', thresholdElement !== null);

              if (thresholdElement) {
                thresholdElement.value = config.DaysThreshold || 180;
                console.log('[DiscontinueWatching] DEBUG: Set threshold input to:', thresholdElement.value);
              } else {
                console.error('[DiscontinueWatching] ERROR: Threshold input element not found!');
              }

              Dashboard.hideLoadingMsg();
            })
            .catch(function (error) {
              console.error('[DiscontinueWatching] ERROR: Error loading configuration:', error);
              Dashboard.hideLoadingMsg();
            });
        },

        loadUsers: function () {
          console.log('[DiscontinueWatching] DEBUG: loadUsers() called');
          return ApiClient.getUsers()
            .then(function (users) {
              console.log('[DiscontinueWatching] DEBUG: Users loaded:', users.length, 'users');
              console.log('[DiscontinueWatching] DEBUG: User list:', users);
              DiscontinueWatchingConfig.users = {};
              users.forEach(function (user) {
                DiscontinueWatchingConfig.users[user.Id] = user.Name;
                console.log('[DiscontinueWatching] DEBUG: Mapped user:', user.Id, '->', user.Name);
              });
              console.log('[DiscontinueWatching] DEBUG: User mapping complete:', DiscontinueWatchingConfig.users);
            })
            .catch(function (error) {
              console.error('[DiscontinueWatching] ERROR: Error loading users:', error);
            });
        },

        loadUserDenylists: function () {
          console.log('[DiscontinueWatching] DEBUG: loadUserDenylists() called');
          var container = document.getElementById('userDenylistsContainer');
          console.log('[DiscontinueWatching] DEBUG: Container element found:', container !== null);
          container.innerHTML = '<p>Loading user denylists...</p>';

          Promise.all([
            ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId),
            DiscontinueWatchingConfig.loadUsers(),
          ])
            .then(function (results) {
              var config = results[0];
              console.log('[DiscontinueWatching] DEBUG: Config loaded for denylists:', config);
              console.log(
                '[DiscontinueWatching] DEBUG: UserDenylistEntries:',
                config.UserDenylistEntries,
                'Length:',
                config.UserDenylistEntries ? config.UserDenylistEntries.length : 'null/undefined'
              );

              if (!config.UserDenylistEntries || config.UserDenylistEntries.length === 0) {
                console.log('[DiscontinueWatching] DEBUG: No denylist entries found');
                container.innerHTML = '<p>No denylisted items found.</p>';
                return;
              }

              console.log('[DiscontinueWatching] DEBUG: Processing', config.UserDenylistEntries.length, 'entries');
              container.innerHTML = '';

              config.UserDenylistEntries.forEach(function (entry, index) {
                console.log('[DiscontinueWatching] DEBUG: Processing entry', index, ':', entry);
                console.log('[DiscontinueWatching] DEBUG: Entry UserId:', entry.UserId);
                console.log('[DiscontinueWatching] DEBUG: Entry ItemIds:', entry.ItemIds);
                console.log(
                  '[DiscontinueWatching] DEBUG: ItemIds length:',
                  entry.ItemIds ? entry.ItemIds.length : 'null/undefined'
                );

                if (!entry.ItemIds || entry.ItemIds.length === 0) {
                  console.log('[DiscontinueWatching] DEBUG: Skipping entry - no items');
                  return;
                }

                var element = DiscontinueWatchingConfig.createUserDenylistEntry(entry);
                console.log('[DiscontinueWatching] DEBUG: Created element:', element);
                container.appendChild(element);
                console.log('[DiscontinueWatching] DEBUG: Appended entry to container');
              });

              console.log('[DiscontinueWatching] DEBUG: Finished rendering denylists');
            })
            .catch(function (error) {
              console.error('[DiscontinueWatching] ERROR: Error loading user denylists:', error);
              console.error('[DiscontinueWatching] ERROR: Error stack:', error.stack);
              container.innerHTML =
                '<p style="color: red;">Error loading user denylists: ' + (error.message || error) + '</p>';
            });
        },

        createUserDenylistEntry: function (entry) {
          console.log('[DiscontinueWatching] DEBUG: createUserDenylistEntry() called for UserId:', entry.UserId);

          var template = document.querySelector('#user-denylist-template');
          console.log('[DiscontinueWatching] DEBUG: Template element found:', template !== null);

          if (!template) {
            console.error('[DiscontinueWatching] ERROR: Template not found!');
            return document.createElement('div');
          }

          var clone = template.content.cloneNode(true);
          console.log('[DiscontinueWatching] DEBUG: Template cloned');

          var detailsElement = clone.querySelector('details');
          var nameHeader = clone.querySelector('.user-name-header');
          var itemsList = clone.querySelector('.user-items-list');
          var arrowIcon = clone.querySelector('.arrow-icon');

          console.log(
            '[DiscontinueWatching] DEBUG: Elements found - details:',
            detailsElement !== null,
            'nameHeader:',
            nameHeader !== null,
            'itemsList:',
            itemsList !== null,
            'arrowIcon:',
            arrowIcon !== null
          );

          var userName = DiscontinueWatchingConfig.users[entry.UserId] || entry.UserId;
          console.log('[DiscontinueWatching] DEBUG: User name resolved:', userName);

          nameHeader.textContent = userName + ' (' + entry.ItemIds.length + ' items)';
          console.log('[DiscontinueWatching] DEBUG: Header text set:', nameHeader.textContent);

          detailsElement.addEventListener('toggle', function () {
            arrowIcon.style.transform = detailsElement.open ? 'rotate(90deg)' : 'rotate(0deg)';
          });

          console.log('[DiscontinueWatching] DEBUG: Processing', entry.ItemIds.length, 'items');
          entry.ItemIds.forEach(function (itemId, index) {
            console.log('[DiscontinueWatching] DEBUG: Creating item element for:', itemId, 'index:', index);

            var itemDiv = document.createElement('div');
            itemDiv.style.cssText =
              'display: flex; align-items: center; justify-content: space-between; padding: 0.5em; margin: 0.25em 0; background-color: rgba(255, 255, 255, 0.03); border-radius: 4px;';

            var itemSpan = document.createElement('span');
            itemSpan.style.fontFamily = 'monospace';
            itemSpan.textContent = itemId;

            var removeBtn = document.createElement('button');
            removeBtn.setAttribute('is', 'emby-button');
            removeBtn.className = 'raised button-cancel';
            removeBtn.innerHTML = '<span>Remove</span>';
            removeBtn.addEventListener('click', function () {
              console.log('[DiscontinueWatching] DEBUG: Remove button clicked for item:', itemId);
              DiscontinueWatchingConfig.removeItemFromUserDenylist(entry.UserId, itemId);
            });

            itemDiv.appendChild(itemSpan);
            itemDiv.appendChild(removeBtn);
            itemsList.appendChild(itemDiv);
            console.log('[DiscontinueWatching] DEBUG: Item element appended');
          });

          console.log('[DiscontinueWatching] DEBUG: createUserDenylistEntry() complete');
          return clone;
        },

        removeItemFromUserDenylist: function (userId, itemId) {
          console.log(
            '[DiscontinueWatching] DEBUG: removeItemFromUserDenylist() called - userId:',
            userId,
            'itemId:',
            itemId
          );

          if (!confirm('Are you sure you want to remove this item from the denylist?')) {
            console.log('[DiscontinueWatching] DEBUG: User cancelled removal');
            return;
          }

          Dashboard.showLoadingMsg();

          ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId)
            .then(function (config) {
              console.log('[DiscontinueWatching] DEBUG: Config loaded for removal:', config);

              var entry = config.UserDenylistEntries.find(function (e) {
                return e.UserId === userId;
              });

              console.log('[DiscontinueWatching] DEBUG: Entry found:', entry);

              if (entry) {
                console.log('[DiscontinueWatching] DEBUG: Before removal - ItemIds:', entry.ItemIds);
                var index = entry.ItemIds.indexOf(itemId);
                console.log('[DiscontinueWatching] DEBUG: Item index:', index);

                if (index > -1) {
                  entry.ItemIds.splice(index, 1);
                  console.log('[DiscontinueWatching] DEBUG: After removal - ItemIds:', entry.ItemIds);
                }

                if (entry.ItemIds.length === 0) {
                  console.log('[DiscontinueWatching] DEBUG: Entry has no items, removing entry');
                  var entryIndex = config.UserDenylistEntries.indexOf(entry);
                  if (entryIndex > -1) {
                    config.UserDenylistEntries.splice(entryIndex, 1);
                    console.log('[DiscontinueWatching] DEBUG: Entry removed from UserDenylistEntries');
                  }
                }

                console.log('[DiscontinueWatching] DEBUG: Updating configuration');
                return ApiClient.updatePluginConfiguration(DiscontinueWatchingConfig.pluginId, config);
              } else {
                console.error('[DiscontinueWatching] ERROR: Entry not found for userId:', userId);
              }
            })
            .then(function () {
              console.log('[DiscontinueWatching] DEBUG: Configuration updated successfully');
              Dashboard.hideLoadingMsg();
              require(['toast'], function (toast) {
                toast('Item removed from denylist');
              });
              DiscontinueWatchingConfig.loadUserDenylists();
            })
            .catch(function (error) {
              Dashboard.hideLoadingMsg();
              console.error('[DiscontinueWatching] ERROR: Error removing item:', error);
              console.error('[DiscontinueWatching] ERROR: Error stack:', error.stack);
              require(['toast'], function (toast) {
                toast('Error removing item from denylist');
              });
            });
        },

        saveConfiguration: function () {
          console.log('[DiscontinueWatching] DEBUG: saveConfiguration() called');
          Dashboard.showLoadingMsg();

          ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId).then(function (config) {
            var thresholdValue = parseInt(document.getElementById('daysThreshold').value, 10);
            console.log('[DiscontinueWatching] DEBUG: Current config before save:', config);
            console.log('[DiscontinueWatching] DEBUG: Setting DaysThreshold to:', thresholdValue);

            config.DaysThreshold = thresholdValue;

            console.log('[DiscontinueWatching] DEBUG: Updated config:', config);
            console.log('[DiscontinueWatching] DEBUG: Calling updatePluginConfiguration');

            ApiClient.updatePluginConfiguration(DiscontinueWatchingConfig.pluginId, config).then(function (result) {
              console.log('[DiscontinueWatching] DEBUG: Configuration saved, result:', result);
              Dashboard.processPluginConfigurationUpdateResult(result);
            });
          });
        },

        registerEvents: function () {
          console.log('[DiscontinueWatching] DEBUG: registerEvents() called');
          var form = document.querySelector('#DiscontinueWatchingConfigForm');
          console.log('[DiscontinueWatching] DEBUG: Form element found:', form !== null);

          if (form) {
            form.addEventListener('submit', function (e) {
              console.log('[DiscontinueWatching] DEBUG: Form submit event triggered');
              e.preventDefault();
              DiscontinueWatchingConfig.saveConfiguration();
              return false;
            });
            console.log('[DiscontinueWatching] DEBUG: Submit event listener registered');
          } else {
            console.error('[DiscontinueWatching] ERROR: Form element not found!');
          }
        },
      };

      console.log('[DiscontinueWatching] DEBUG: Script loaded, waiting for pageshow event');

      // Try multiple initialization approaches
      document.addEventListener('pageshow', function (e) {
        console.log('[DiscontinueWatching] DEBUG: pageshow event fired for page:', e.target.id);

        if (e.target.id === 'DiscontinueWatchingConfigPage') {
          console.log('[DiscontinueWatching] DEBUG: Matched our config page, initializing...');
          DiscontinueWatchingConfig.loadConfiguration();
          DiscontinueWatchingConfig.loadUserDenylists();
          DiscontinueWatchingConfig.registerEvents();
          console.log('[DiscontinueWatching] DEBUG: Initialization complete');
        }
      });

      // Also try viewshow event (Jellyfin uses this)
      document.addEventListener('viewshow', function (e) {
        console.log('[DiscontinueWatching] DEBUG: viewshow event fired for page:', e.detail?.type, e.target.id);

        if (e.target.id === 'DiscontinueWatchingConfigPage') {
          console.log('[DiscontinueWatching] DEBUG: viewshow matched our config page, initializing...');
          DiscontinueWatchingConfig.loadConfiguration();
          DiscontinueWatchingConfig.loadUserDenylists();
          DiscontinueWatchingConfig.registerEvents();
          console.log('[DiscontinueWatching] DEBUG: Initialization complete via viewshow');
        }
      });

      // Also try DOMContentLoaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
          console.log('[DiscontinueWatching] DEBUG: DOMContentLoaded fired');
          var page = document.getElementById('DiscontinueWatchingConfigPage');
          if (page) {
            console.log('[DiscontinueWatching] DEBUG: Page found via DOMContentLoaded, initializing...');
            DiscontinueWatchingConfig.loadConfiguration();
            DiscontinueWatchingConfig.loadUserDenylists();
            DiscontinueWatchingConfig.registerEvents();
          }
        });
      } else {
        console.log('[DiscontinueWatching] DEBUG: Document already loaded, trying immediate init');
        var page = document.getElementById('DiscontinueWatchingConfigPage');
        if (page) {
          console.log('[DiscontinueWatching] DEBUG: Page found, initializing immediately...');
          // Use setTimeout to ensure DOM is fully ready
          setTimeout(function () {
            DiscontinueWatchingConfig.loadConfiguration();
            DiscontinueWatchingConfig.loadUserDenylists();
            DiscontinueWatchingConfig.registerEvents();
          }, 100);
        }
      }

      console.log('[DiscontinueWatching] DEBUG: All event listeners registered');
    </script>
  </body>
</html>
