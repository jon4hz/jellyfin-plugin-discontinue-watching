<!DOCTYPE html>
<html>
  <head>
    <title>Discontinue Watching</title>
  </head>
  <body>
    <div id="DiscontinueWatchingConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
      <div data-role="content">
        <div class="content-primary">
          <form id="DiscontinueWatchingConfigForm">
            <div class="verticalSection verticalSection-extrabottompadding">
              <div class="sectionTitleContainer flex align-items-center">
                <h2 class="sectionTitle">Discontinue Watching Plugin</h2>
                <a
                  is="emby-linkbutton"
                  class="raised raised-mini emby-button"
                  style="margin-left: 2em"
                  target="_blank"
                  href="https://github.com/jon4hz/jellyfin-plugin-discontinue-watching"
                >
                  <i class="md-icon button-icon button-icon-left secondaryText"></i>
                  <span>GitHub</span>
                </a>
              </div>
              <p class="fieldDescription">
                This plugin allows users to hide items from their "Continue Watching" list. Hidden items will
                automatically reappear when playback is resumed.
              </p>
              <hr />
              <br />

              <div class="verticalSection">
                <h3 class="sectionTitle">Settings</h3>
                <div class="inputContainer">
                  <input
                    is="emby-input"
                    type="number"
                    id="daysThreshold"
                    label="Days Threshold:"
                    min="1"
                    max="365"
                    step="1"
                  />
                  <div class="fieldDescription">
                    Items that haven't been watched for this many days will be automatically removed from Continue
                    Watching by the scheduled task. (Default: 180 days)
                  </div>
                </div>
              </div>

              <br />
              <div>
                <button is="emby-button" type="submit" class="raised button-submit block">
                  <span>Save</span>
                </button>
              </div>

              <br />
              <hr />
              <br />

              <div class="verticalSection">
                <h3 class="sectionTitle">User Denylists</h3>
                <p class="fieldDescription" style="margin-bottom: 1em">
                  Manage user-specific denylists. These items are hidden from the Continue Watching section until
                  playback resumes.
                </p>
                <div id="userDenylistsContainer">
                  <p>Loading user denylists...</p>
                </div>
              </div>

              <br />
              <hr />
              <br />

              <div class="verticalSection">
                <h3 class="sectionTitle">Features</h3>
                <ul>
                  <li>Hide items from Continue Watching via API</li>
                  <li>User-specific denylist management</li>
                  <li>Automatic removal from denylist when playback resumes</li>
                  <li>Scheduled cleanup of old Continue Watching items</li>
                </ul>
              </div>

              <div class="verticalSection">
                <h3 class="sectionTitle">Scheduled Task</h3>
                <p class="fieldDescription">
                  A scheduled task runs to automatically hide items from Continue Watching that haven't been watched
                  within the configured threshold. You can manually trigger this task from the Jellyfin dashboard under
                  Scheduled Tasks.
                </p>
              </div>

              <div class="verticalSection">
                <h3 class="sectionTitle">API Endpoints</h3>
                <p class="fieldDescription">The following authenticated API endpoints are available:</p>
                <ul>
                  <li><strong>GET</strong> /DiscontinueWatching - Get all denylisted items</li>
                  <li><strong>POST</strong> /DiscontinueWatching/{itemId} - Add item to denylist</li>
                  <li><strong>DELETE</strong> /DiscontinueWatching/{itemId} - Remove item from denylist</li>
                </ul>
              </div>
            </div>
          </form>
        </div>
      </div>

      <template id="user-denylist-template">
        <details
          class="verticalSection"
          style="background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 1em"
        >
          <summary style="cursor: pointer; list-style: none; display: flex; align-items: center; padding: 0.75em 1em">
            <i class="material-icons arrow-icon" style="transition: transform 0.2s ease-in-out">arrow_right</i>
            <h3 class="sectionTitle user-name-header" style="margin: 0 0 0 0.5em"></h3>
          </summary>
          <div class="user-denylist-container" style="padding: 1.5em; border-top: 1px solid rgba(255, 255, 255, 0.1)">
            <div class="user-items-list"></div>
          </div>
        </details>
      </template>

      <script type="text/javascript">
        var DiscontinueWatchingConfig = {
          pluginId: '74a22212-e4c5-4b5c-8d77-04e7e220f28d',
          users: {},

          loadConfiguration: function () {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId)
              .then(function (config) {
                document.getElementById('daysThreshold').value = config.DaysThreshold || 180;
                Dashboard.hideLoadingMsg();
              })
              .catch(function (error) {
                console.error('[DiscontinueWatching] Error loading configuration:', error);
                Dashboard.hideLoadingMsg();
              });
          },

          loadUsers: function () {
            return ApiClient.getUsers().then(function (users) {
              DiscontinueWatchingConfig.users = {};
              users.forEach(function (user) {
                DiscontinueWatchingConfig.users[user.Id] = user.Name;
              });
            });
          },

          loadUserDenylists: function () {
            var container = document.getElementById('userDenylistsContainer');
            container.innerHTML = '<p>Loading user denylists...</p>';

            Promise.all([
              ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId),
              DiscontinueWatchingConfig.loadUsers(),
            ])
              .then(function (results) {
                var config = results[0];

                if (!config.UserDenylistEntries || config.UserDenylistEntries.length === 0) {
                  container.innerHTML = '<p>No denylisted items found.</p>';
                  return;
                }

                container.innerHTML = '';

                config.UserDenylistEntries.forEach(function (entry) {
                  if (!entry.ItemIds || entry.ItemIds.length === 0) {
                    return;
                  }

                  container.appendChild(DiscontinueWatchingConfig.createUserDenylistEntry(entry));
                });
              })
              .catch(function (error) {
                console.error('[DiscontinueWatching] Error loading user denylists:', error);
                container.innerHTML =
                  '<p style="color: red;">Error loading user denylists: ' + (error.message || error) + '</p>';
              });
          },

          createUserDenylistEntry: function (entry) {
            var template = document.querySelector('#user-denylist-template');
            var clone = template.content.cloneNode(true);

            var detailsElement = clone.querySelector('details');
            var nameHeader = clone.querySelector('.user-name-header');
            var itemsList = clone.querySelector('.user-items-list');
            var arrowIcon = clone.querySelector('.arrow-icon');

            var userName = DiscontinueWatchingConfig.users[entry.UserId] || entry.UserId;
            nameHeader.textContent = userName + ' (' + entry.ItemIds.length + ' items)';

            detailsElement.addEventListener('toggle', function () {
              arrowIcon.style.transform = detailsElement.open ? 'rotate(90deg)' : 'rotate(0deg)';
            });

            entry.ItemIds.forEach(function (itemId) {
              var itemDiv = document.createElement('div');
              itemDiv.style.cssText =
                'display: flex; align-items: center; justify-content: space-between; padding: 0.5em; margin: 0.25em 0; background-color: rgba(255, 255, 255, 0.03); border-radius: 4px;';

              var itemSpan = document.createElement('span');
              itemSpan.style.fontFamily = 'monospace';
              itemSpan.textContent = itemId;

              var removeBtn = document.createElement('button');
              removeBtn.setAttribute('is', 'emby-button');
              removeBtn.className = 'raised button-cancel';
              removeBtn.innerHTML = '<span>Remove</span>';
              removeBtn.addEventListener('click', function () {
                DiscontinueWatchingConfig.removeItemFromUserDenylist(entry.UserId, itemId);
              });

              itemDiv.appendChild(itemSpan);
              itemDiv.appendChild(removeBtn);
              itemsList.appendChild(itemDiv);
            });

            return clone;
          },

          removeItemFromUserDenylist: function (userId, itemId) {
            if (!confirm('Are you sure you want to remove this item from the denylist?')) {
              return;
            }

            Dashboard.showLoadingMsg();

            ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId)
              .then(function (config) {
                var entry = config.UserDenylistEntries.find(function (e) {
                  return e.UserId === userId;
                });

                if (entry) {
                  var index = entry.ItemIds.indexOf(itemId);
                  if (index > -1) {
                    entry.ItemIds.splice(index, 1);
                  }

                  if (entry.ItemIds.length === 0) {
                    var entryIndex = config.UserDenylistEntries.indexOf(entry);
                    if (entryIndex > -1) {
                      config.UserDenylistEntries.splice(entryIndex, 1);
                    }
                  }

                  return ApiClient.updatePluginConfiguration(DiscontinueWatchingConfig.pluginId, config);
                }
              })
              .then(function () {
                Dashboard.hideLoadingMsg();
                require(['toast'], function (toast) {
                  toast('Item removed from denylist');
                });
                DiscontinueWatchingConfig.loadUserDenylists();
              })
              .catch(function (error) {
                Dashboard.hideLoadingMsg();
                console.error('[DiscontinueWatching] Error removing item:', error);
                require(['toast'], function (toast) {
                  toast('Error removing item from denylist');
                });
              });
          },

          saveConfiguration: function () {
            Dashboard.showLoadingMsg();

            ApiClient.getPluginConfiguration(DiscontinueWatchingConfig.pluginId).then(function (config) {
              config.DaysThreshold = parseInt(document.getElementById('daysThreshold').value, 10);

              ApiClient.updatePluginConfiguration(DiscontinueWatchingConfig.pluginId, config).then(function (result) {
                Dashboard.processPluginConfigurationUpdateResult(result);
              });
            });
          },

          registerEvents: function () {
            document.querySelector('#DiscontinueWatchingConfigForm').addEventListener('submit', function (e) {
              e.preventDefault();
              DiscontinueWatchingConfig.saveConfiguration();
              return false;
            });
          },
        };

        document.addEventListener('pageshow', function (e) {
          if (e.target.id === 'DiscontinueWatchingConfigPage') {
            DiscontinueWatchingConfig.loadConfiguration();
            DiscontinueWatchingConfig.loadUserDenylists();
            DiscontinueWatchingConfig.registerEvents();
          }
        });
      </script>
    </div>
  </body>
</html>
